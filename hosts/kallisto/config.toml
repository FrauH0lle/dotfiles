# Modules
depends = [
  "base",
  "shell/bash",
  "shell/zsh",
  "desktop/plasma",
  "desktop/apps/calibre",
  "desktop/apps/libreoffice",
  "desktop/fonts",
  "desktop/spelling",
  "editors/emacs",
  "hardware/hp-printer",
  "dev/R",
  "dev/rust",
  "dev/containers",
  "services/samba",
  "vm/virtualbox",
  "browsers/vivaldi",
  "backup/snapper"
]

# Packages
[[packages]]
install = [ "dotdeploy/host-kallisto" ]
eval_when = "(eq DOD_DISTRO 'gentoo')"

# Files
[files]
# Host portage and package configuration
[files."/etc/portage/*"]
source = "gentoo/portage/*"
phase = "setup"
action = "copy"
eval_when = "(eq DOD_DISTRO 'gentoo')"

# System tweaks
[files."/etc/*"]
source = "gentoo/tweaks/*"
phase = "config"
action = "copy"
eval_when = "(eq DOD_DISTRO 'gentoo')"

# Host specific dotfiles
[files."$HOME/*"]
source = "home/*"
phase = "config"
action = "link"

# Files to generate
[generate."$HOME/.env.sh"]
prepend = """
#!/bin/sh
# This file was auto-generated by dotdeploy.
# It is NOT safe to edit this file. Changes will be overwritten!

# Prepend directory to PATH if directory exists
# Arguments:
#   $1 - Directory
#   $2 - if 'after' is set, append to PATH
# Env:
#   $PATH
# Outputs:
#   None. Prepends or appands to $PATH if $2 is 'after'
pathmunge() {
    case ":${PATH}:" in
        *:"$1":*)
            ;;
        *)
            if [ "$2" = "after" ] ; then
                PATH=$PATH:$1
            else
                PATH=$1:$PATH
            fi
    esac
}
"""
source = "env.sh"
append = "unset -f pathmunge"

[generate."$HOME/.fzf.sh"]
source = "fzf.sh"
prepend = """
# This file was auto-generated by dotdeploy.
# It is NOT safe to edit this file. Changes will be overwritten!
"""

[generate."$HOME/.aliases.sh"]
source = "aliases.sh"
prepend = """
# This file was auto-generated by dotdeploy.
# It is NOT safe to edit this file. Changes will be overwritten!
"""

[generate."$HOME/.completions.sh"]
source = "completions.sh"
prepend = """
# This file was auto-generated by dotdeploy.
# It is NOT safe to edit this file. Changes will be overwritten!
"""

# Actions
[[actions.config.main]]
exec = """
# Enable fstrim
sudo systemctl enable fstrim.timer
"""

# Context variables for template expansion
[context_vars]
ncpu = "16"
